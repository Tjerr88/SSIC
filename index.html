<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>S&S & Iron Cardio</title>

<style>
:root{
  --bg:#0b0d12;
  --txt:#eef2ff;
  --muted:#a6b0c6;
  --line:rgba(255,255,255,.10);
  --good:#2dd4bf;
  --bad:#fb7185;
  --warn:#fbbf24;
  --accent:#8b5cf6;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background: var(--bg);
  color:var(--txt);
  padding:14px 14px calc(18px + env(safe-area-inset-bottom));
}
.container{max-width:720px;margin:0 auto}
h1{font-size:18px;margin:0}
.small{font-size:12px;color:var(--muted);line-height:1.35}
.top{
  padding:14px;
  border:1px solid var(--line);
  border-radius:18px;
  background: rgba(255,255,255,.02);
}
.statusRow{
  margin-top:10px;
  display:flex;gap:10px;flex-wrap:wrap;
  color:var(--muted);
  font-size:13px;
}
.badge{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 10px;border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.02);
}
.dot{width:9px;height:9px;border-radius:50%;background:#64748b}
.dot.good{background:var(--good)}
.dot.bad{background:var(--bad)}
.dot.warn{background:var(--warn)}
.tabs{ margin-top:12px; display:flex; gap:8px; }
.tab{
  flex:1; padding:10px 10px;
  border-radius:14px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.02);
  color:var(--muted);
  font-weight:750;
}
.tab.active{
  color:var(--txt);
  border-color: rgba(139,92,246,.5);
  background: rgba(139,92,246,.12);
}
.section{margin-top:12px}
.card{
  padding:14px;
  border:1px solid var(--line);
  border-radius:18px;
  background: rgba(255,255,255,.02);
}
.hr{height:1px;background:var(--line);margin:12px 0}
details{
  border:1px solid var(--line);
  border-radius:16px;
  background: rgba(255,255,255,.015);
  overflow:hidden;
}
details + details{margin-top:10px}
summary{
  list-style:none;
  cursor:pointer;
  padding:12px 12px;
  display:flex;align-items:center;justify-content:space-between;
  font-weight:850;
}
summary::-webkit-details-marker{display:none}
.detailsBody{padding:0 12px 12px 12px}
.list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
.item{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 10px;
  border:1px solid var(--line);
  border-radius:14px;
  background: rgba(0,0,0,.12);
}
.item label{display:flex;gap:10px;align-items:center;cursor:pointer}
.item input[type="checkbox"]{width:20px;height:20px}
.mono{font-variant-numeric: tabular-nums; font-feature-settings:"tnum" 1;}
.timerBox{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:16px;
  padding:12px;
  background: rgba(0,0,0,.14);
}
.bigTime{font-size:44px;font-weight:900;line-height:1;margin:6px 0 10px}
.btnRow{display:flex;gap:10px;flex-wrap:wrap}
button{
  border:none;cursor:pointer;
  padding:12px 12px;
  border-radius:14px;
  font-weight:850;
  font-size:16px;
}
.btn{background: rgba(255,255,255,.06); color:var(--txt); border:1px solid var(--line)}
.btn.good{border-color: rgba(45,212,191,.35); background: rgba(45,212,191,.12)}
.btn.bad{border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.10)}
.btn.warn{border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.10)}
input[type="number"], select{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  color: var(--txt);
  outline:none;
  font-size:15px;
}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:720px){ .grid{grid-template-columns:1fr 1fr} h1{font-size:20px} }
</style>

</head>
<body>
<div class="container">
  <div class="top">
    <h1>S&S + Iron Cardio</h1>
    <div class="statusRow">
      <span class="badge"><span class="dot" id="dotWake"></span><span id="chipWake">Wake lock: uit</span></span>
      <span class="badge"><span class="dot good"></span><span id="chipToday">Vandaag: —</span></span>
      <span class="badge"><span class="dot"></span><span id="chipIC">IC: —</span></span>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="today">Vandaag</button>
      <button class="tab" data-tab="settings">Settings</button>
      <button class="tab" data-tab="history">History</button>
    </div>
  </div>

  <section class="section" id="tab-today">
    <div class="card">
      <div class="small" id="todayTags"></div>

      <details id="accWarm" open>
        <summary><span>Warm-up (3 rondes)</span><span class="tag">dicht</span></summary>
        <div class="detailsBody">
          <div class="small">3 rondes, rustig ademend. Geen haast.</div>
          <div class="list">
            <div class="item"><div class="left">• Prying squat</div></div>
            <div class="item"><div class="left">• Halo (links/rechts)</div></div>
            <div class="item"><div class="left">• Hip bridge</div></div>
          </div>
        </div>
      </details>

      <details id="accMain1">
        <summary><span id="main1Title">Swings</span><span class="tag">dicht</span></summary>
        <div class="detailsBody">
          <div class="small" id="main1Sub">—</div>
          <div class="list" id="main1List"></div>
        </div>
      </details>

      <details id="accMain2">
        <summary><span id="main2Title">Get-ups</span><span class="tag">dicht</span></summary>
        <div class="detailsBody">
          <div class="small" id="main2Sub">—</div>
          <div class="list" id="main2List"></div>
        </div>
      </details>

      <details id="accIC" style="display:none">
        <summary><span>Iron Cardio</span><span class="tag">dicht</span></summary>
        <div class="detailsBody">
          <div class="small" id="icSummary">—</div>
          <div class="hr"></div>
          <div class="row">
            <span class="tag"><strong>Sets</strong> <span class="mono" id="icSets">0</span></span>
            <button class="btn" id="btnIcMinus">−</button>
            <button class="btn" id="btnIcPlus">+</button>
          </div>
        </div>
      </details>

      <div class="hr"></div>

      <div class="timerBox">
        <div class="row" style="justify-content:space-between">
          <span class="tag" id="timerModeTag">Timer</span>
          <span class="tag"><strong>Status</strong> <span id="statusText">klaar</span></span>
        </div>
        <div class="bigTime mono" id="timeDisplay">00:00</div>
        <div class="small" id="timerHint">—</div>
        <div class="btnRow" style="margin-top:12px">
          <button class="btn good" id="btnStart">Start</button>
          <button class="btn" id="btnPause">Pauze</button>
          <button class="btn bad" id="btnComplete">Complete</button>
        </div>
      </div>

      <details id="accCool">
        <summary><span>Cooling down</span><span class="tag">dicht</span></summary>
        <div class="detailsBody">
          <div class="small">1 minuut per kant: 90/90 + 1 minuut per kant straddle.</div>
          <div class="timerBox" style="margin-top:10px">
            <div class="row" style="justify-content:space-between">
              <span class="tag">Cooling timer</span>
              <span class="tag"><strong>Status</strong> <span id="coolStatus">klaar</span></span>
            </div>
            <div class="bigTime mono" id="coolTime">00:00</div>
            <div class="btnRow" style="margin-top:12px">
              <button class="btn good" id="btnCoolStart">Start</button>
              <button class="btn" id="btnCoolPause">Pauze</button>
              <button class="btn warn" id="btnCoolReset">Reset</button>
            </div>
          </div>
        </div>
      </details>

    </div>
  </section>

  <section class="section" id="tab-settings" style="display:none">
    <div class="card">
      <h2 style="margin:4px 0 10px 0;font-size:18px">Programma</h2>
      <div class="grid">
        <div>
          <label class="small">S&amp;S aan</label>
          <select id="setEnableSS">
            <option value="1">Aan</option>
            <option value="0">Uit</option>
          </select>
        </div>
        <div>
          <label class="small">Iron Cardio aan</label>
          <select id="setEnableIC">
            <option value="1">Aan</option>
            <option value="0">Uit</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>

      <h2 style="margin:4px 0 10px 0;font-size:18px">S&amp;S settings</h2>
      <div class="grid">
        <div>
          <label class="small">S (standaard bell, kg)</label>
          <input type="number" id="ssBell" min="8" step="4" value="24"/>
        </div>
        <div>
          <label class="small">S+ (kg) (default = S+8)</label>
          <input type="number" id="ssBellPlus" min="8" step="4" value="32"/>
        </div>
      </div>
      <div class="grid" style="margin-top:10px">
        <div>
          <label class="small">Elke 3e S&amp;S sessie = two-hand swing</label>
          <select id="twoArmEveryThird">
            <option value="1">Aan</option>
            <option value="0">Uit</option>
          </select>
        </div>
        <div>
          <label class="small">Timed label tonen als S&lt;32 (slot #3 blijft)</label>
          <select id="timedVisible">
            <option value="1">Ja</option>
            <option value="0">Nee</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>

      <h2 style="margin:4px 0 10px 0;font-size:18px">IC load settings</h2>
      <div class="grid">
        <div>
          <label class="small">IC Easy load (kg)</label>
          <input type="number" id="icEasy" min="8" step="4" value="16"/>
        </div>
        <div>
          <label class="small">IC Medium load (kg)</label>
          <input type="number" id="icMed" min="8" step="4" value="20"/>
        </div>
        <div>
          <label class="small">IC Heavy load (kg)</label>
          <input type="number" id="icHeavy" min="8" step="4" value="24"/>
        </div>
        <div>
          <label class="small">Double bell beschikbaar?</label>
          <select id="icDoubleOK">
            <option value="1">Ja</option>
            <option value="0">Nee</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <button class="btn warn" id="btnResetAll">Reset alle data</button>
      </div>
      <p class="small" style="margin-top:10px">Reset wist localStorage (history + counters).</p>
    </div>
  </section>

  <section class="section" id="tab-history" style="display:none">
    <div class="card">
      <h2 style="margin:4px 0 10px 0;font-size:18px">History</h2>
      <div class="small">Laatste sessies (Complete).</div>
      <div class="hr"></div>
      <div id="histList" class="list"></div>
    </div>
  </section>

</div>

<script>
const LS_KEY = "SS_IC_APP_matrix_v1";
const pad2 = n => String(n).padStart(2,"0");
const isoToday = () => { const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };
const fmtMs = (ms) => { ms=Math.max(0,Math.floor(ms)); const s=Math.floor(ms/1000); return `${pad2(Math.floor(s/60))}:${pad2(s%60)}`; };
const randDie = () => 1 + Math.floor(Math.random()*6);
const safeInt = (v,f)=>{ const n=parseInt(v,10); return Number.isFinite(n)?n:f; };
const clamp4 = (n)=>{ n=Math.floor(n/4)*4; return Math.max(8,n); };

function beepDouble(){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const mk=(t)=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.connect(g); g.connect(ctx.destination);
      o.type="sine"; o.frequency.value=880; g.gain.value=0.0001;
      g.gain.exponentialRampToValueAtTime(0.15, t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t+0.18);
      o.start(t); o.stop(t+0.19);
    };
    const t=ctx.currentTime;
    mk(t); mk(t+0.30);
  }catch(e){}
}

function defaultState(){
  return {
    settings:{
      enableSS:true, enableIC:true,
      ssBell:24, ssBellPlus:32,
      twoArmEveryThird:true, timedVisible:true,
      icEasy:16, icMed:20, icHeavy:24,
      icDoubleOK:true
    },
    counters:{ ssCounter:0 },
    session:{
      todayDate: isoToday(),
      programPlanned:null,
      ss:null, ic:null,
      checks:{}, icSets:0,
      startedAt:null, paused:false, pausedAt:null, totalPausedMs:0,
      icCountdownMs:null, icDoneBeep:false,
      coolStartedAt:null, coolPaused:false, coolPausedAt:null, coolTotalPausedMs:0
    },
    history:[]
  };
}
function load(){
  try{
    const raw=localStorage.getItem(LS_KEY);
    if(!raw) return defaultState();
    const st=JSON.parse(raw);
    if(!st.settings) return defaultState();
    st.settings.enableSS=!!st.settings.enableSS;
    st.settings.enableIC=!!st.settings.enableIC;
    st.settings.twoArmEveryThird=!!st.settings.twoArmEveryThird;
    st.settings.timedVisible=(st.settings.timedVisible!==false);
    st.settings.icDoubleOK=(st.settings.icDoubleOK!==false);
    st.counters ||= {ssCounter:0};
    st.session ||= defaultState().session;
    st.history ||= [];
    return st;
  }catch(e){ return defaultState(); }
}
let state = load();
const save=()=>localStorage.setItem(LS_KEY, JSON.stringify(state));
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const nowMs=()=>Date.now();

let wakeLock=null;
async function setWake(on){
  try{
    if(on){
      if('wakeLock' in navigator){ wakeLock=await navigator.wakeLock.request('screen'); }
    }else{
      if(wakeLock){ await wakeLock.release(); wakeLock=null; }
    }
  }catch(e){}
  renderChips();
}

function getLastCompleted(){
  const h=state.history;
  return h.length ? h[h.length-1] : null;
}

function buildSS(){
  const ssCount=state.counters.ssCounter||0;
  const microIndex=(ssCount%5)+1;
  const timed=(microIndex===3);
  const stepIdx=Math.floor(ssCount/15)%5;
  const sPlusSets=[0,2,4,6,8][stepIdx];
  const S=clamp4(state.settings.ssBell||24);
  const Splus=clamp4(state.settings.ssBellPlus|| (S+8));
  const Sminus=clamp4(Math.max(8,S-8));
  const twoArm=state.settings.twoArmEveryThird ? (((ssCount+1)%3)===0) : false;
  state.session.ss={microIndex,timed,sPlusSets,S,Splus,Sminus,twoArm};
  state.session.ic=null;
  state.session.icCountdownMs=null;
  state.session.icDoneBeep=false;
}

function chooseICOnce(){
  const a=randDie();
  const sessionType=(a<=2)?"Easy":(a<=5?"Medium":"Hard");
  const b=randDie();
  const timeMin=(b<=2)?15:(b<=5?20:30);
  const c=randDie();
  const loadLevel=(c<=2)?"Easy":(c<=5?"Medium":"Heavy");
  const loadKg=clamp4(loadLevel==="Easy"?state.settings.icEasy:(loadLevel==="Medium"?state.settings.icMed:state.settings.icHeavy));
  const cellKey=`${sessionType}_${loadLevel}`;
  const d=randDie();

  let variantKey="FIXED", variantText="";

  if(sessionType==="Easy" && loadLevel==="Heavy"){
    variantKey="HEAVY_EASY_FIXED";
    variantText="Clean • Push Press • Goblet Squat (vast)";
  }else if(sessionType==="Hard" && loadLevel==="Easy"){
    if(!state.settings.icDoubleOK){
      variantKey=(d<=2)?"SB_CLASSIC_SNATCH":(d<=5?"TRAVELING_2S":"MOVING_TARGET");
      variantText=(variantKey==="SB_CLASSIC_SNATCH")?"Classic + Snatch":(variantKey==="TRAVELING_2S"?"Traveling 2's":"Moving Target");
    }else{
      variantKey=(d<=2)?"DB_CLASSIC":(d<=5?"DB_CLASSIC_SNATCH":"DB_SFG2");
      variantText=(variantKey==="DB_CLASSIC")?"Double Bell Classic":(variantKey==="DB_CLASSIC_SNATCH"?"Double Classic + Snatch":"Double Bell SFG II (Press → Push Press → Jerk)");
    }
  }else if(sessionType==="Medium"){
    variantKey=(d<=2)?"PRESS_LADDER":(d<=5?"WEIGHT_LADDER":"SFG1");
    variantText=(variantKey==="PRESS_LADDER")?"Press ladder":(variantKey==="WEIGHT_LADDER"?"Weight ladder":"SFG I");
  }else if(sessionType==="Hard"){
    variantKey=(d<=2)?"CLASSIC_SNATCH":(d<=5?"TRAVELING_2S":"MOVING_TARGET");
    variantText=(variantKey==="CLASSIC_SNATCH")?"Classic + Snatch":(variantKey==="TRAVELING_2S"?"Traveling 2's":"Moving Target");
  }else{
    variantKey="CLASSIC";
    variantText="Classic (Clean • Press • Squat)";
  }

  return {die:{a,b,c,d}, sessionType, timeMin, loadLevel, loadKg, cellKey, variantKey, variantText};
}

function buildIC(){
  const last=getLastCompleted();
  const lastIC=(last && last.program==="IC")? last : null;
  const lastTime=lastIC ? lastIC.ic?.timeMin : null;
  const lastVar=lastIC ? lastIC.ic?.variantKey : null;

  let pick=null;
  for(let i=0;i<25;i++){
    const cand=chooseICOnce();
    if((lastTime!=null && cand.timeMin===lastTime) || (lastVar!=null && cand.variantKey===lastVar)) continue;
    pick=cand; break;
  }
  if(!pick) pick=chooseICOnce();
  state.session.ic=pick;
  state.session.ss=null;
  state.session.icCountdownMs=pick.timeMin*60*1000;
  state.session.icDoneBeep=false;
}

function planForToday(){
  if(!state.settings.enableSS && !state.settings.enableIC) state.settings.enableSS=true;

  const today=isoToday();
  if(state.session.todayDate!==today){
    state.session.todayDate=today;
    state.session.startedAt=null;
    state.session.paused=false;
    state.session.pausedAt=null;
    state.session.totalPausedMs=0;
    state.session.coolStartedAt=null;
    state.session.coolPaused=false;
    state.session.coolPausedAt=null;
    state.session.coolTotalPausedMs=0;
    state.session.icDoneBeep=false;
  }

  let planned=state.session.programPlanned;
  const ssOn=!!state.settings.enableSS, icOn=!!state.settings.enableIC;
  if(!planned || (planned==="SS" && !ssOn) || (planned==="IC" && !icOn)){
    const last=getLastCompleted();
    const lastProg=last?last.program:null;
    if(ssOn && icOn) planned = lastProg ? (lastProg==="SS"?"IC":"SS") : "SS";
    else planned = ssOn ? "SS" : "IC";
    state.session.programPlanned=planned;
    state.session.ss=null; state.session.ic=null;
    state.session.checks={}; state.session.icSets=0;
    state.session.startedAt=null; state.session.paused=false; state.session.totalPausedMs=0;
  }

  if(planned==="SS"){
    if(!state.session.ss) buildSS();
  }else{
    if(!state.session.ic) buildIC();
  }
  save();
}

function setDetailsLabel(el){
  const t=el.querySelector("summary .tag"); if(!t) return;
  t.textContent = el.open ? "open" : "dicht";
}
function renderChips(){
  const dot=$("#dotWake"), chip=$("#chipWake");
  if(wakeLock){ dot.className="dot good"; chip.textContent="Wake lock: aan"; }
  else { dot.className="dot"; chip.textContent="Wake lock: uit"; }
}

function renderSSLists(){
  const ss=state.session.ss;
  const swingsSub=$("#main1Sub"), swingsList=$("#main1List");
  const guSub=$("#main2Sub"), guList=$("#main2List");

  const timed = ss.timed && (ss.S>=32 || state.settings.timedVisible);
  swingsSub.textContent = timed
    ? `Timed slot #3: 100 swings @ ${ss.Sminus}kg (S−).`
    : `Practice: ${ss.sPlusSets}/10 sets per kant @ S+ (${ss.Splus}kg), rest @ S (${ss.S}kg).`;

  guSub.textContent = timed
    ? `Timed slot #3: 10 get-ups @ ${ss.Sminus}kg (S−).`
    : `Practice: ${ss.sPlusSets}/10 reps per kant @ S+ (${ss.Splus}kg), rest @ S (${ss.S}kg).`;

  swingsList.innerHTML=""; guList.innerHTML="";

  for(let i=0;i<10;i++){
    const usePlus = (!timed) && (i < ss.sPlusSets);
    const w = timed ? ss.Sminus : (usePlus ? ss.Splus : ss.S);
    const key=`sw-${i}`;
    const checked=!!state.session.checks[key];
    const label = ss.twoArm ? `10 two-hand swings @ ${w}kg` : `10 swings ${i%2===0?"L":"R"} @ ${w}kg`;
    swingsList.insertAdjacentHTML("beforeend", `<div class="item"><div class="left"><label><input type="checkbox" data-k="${key}" ${checked?"checked":""}/> <span>${label}</span></label></div></div>`);
  }
  for(let i=0;i<10;i++){
    const usePlus = (!timed) && (i < ss.sPlusSets);
    const w = timed ? ss.Sminus : (usePlus ? ss.Splus : ss.S);
    const key=`gu-${i}`;
    const checked=!!state.session.checks[key];
    const label=`Get-up ${i%2===0?"L":"R"} @ ${w}kg`;
    guList.insertAdjacentHTML("beforeend", `<div class="item"><div class="left"><label><input type="checkbox" data-k="${key}" ${checked?"checked":""}/> <span>${label}</span></label></div></div>`);
  }
  swingsList.onchange=(e)=>{ const k=e.target?.dataset?.k; if(!k) return; state.session.checks[k]=!!e.target.checked; save(); };
  guList.onchange=(e)=>{ const k=e.target?.dataset?.k; if(!k) return; state.session.checks[k]=!!e.target.checked; save(); };
}

function renderICBlock(){
  const ic=state.session.ic;
  $("#icSets").textContent=String(state.session.icSets||0);
  $("#icSummary").innerHTML = `<strong>${ic.sessionType}</strong> session · <strong>${ic.timeMin} min</strong> · <strong>${ic.loadLevel}</strong> (${ic.loadKg}kg)
    <br/><span class="small">Dobbel: A=${ic.die.a}, B=${ic.die.b}, C=${ic.die.c}, D=${ic.die.d}</span>
    <div class="hr"></div>
    <div class="small"><strong>Variant:</strong> ${ic.variantText}</div>`;
}

function sessionElapsedMs(){
  if(!state.session.startedAt) return 0;
  const base = (state.session.paused ? state.session.pausedAt : nowMs()) - state.session.startedAt;
  return Math.max(0, base - (state.session.totalPausedMs||0));
}
function renderTimer(){
  const prog=state.session.programPlanned;
  const status=$("#statusText"), display=$("#timeDisplay");
  if(!state.session.startedAt){
    status.textContent="klaar";
    display.textContent = (prog==="IC" && state.session.icCountdownMs!=null) ? fmtMs(state.session.icCountdownMs) : "00:00";
    return;
  }
  status.textContent = state.session.paused ? "pauze" : "loopt";
  if(prog==="SS"){
    display.textContent = fmtMs(sessionElapsedMs());
  }else{
    const rem = Math.max(0, (state.session.icCountdownMs||0) - sessionElapsedMs());
    display.textContent = fmtMs(rem);
    if(rem===0 && !state.session.icDoneBeep){ state.session.icDoneBeep=true; save(); beepDouble(); }
  }
}
function startSession(){
  if(!state.session.startedAt){
    state.session.startedAt=nowMs(); state.session.paused=false; state.session.totalPausedMs=0; state.session.icDoneBeep=false;
    save(); setWake(true); renderAll(); return;
  }
  if(state.session.paused){
    const pausedDur = nowMs() - (state.session.pausedAt||nowMs());
    state.session.totalPausedMs = (state.session.totalPausedMs||0) + pausedDur;
    state.session.paused=false; state.session.pausedAt=null;
    save(); setWake(true); renderAll();
  }
}
function pauseSession(){
  if(!state.session.startedAt || state.session.paused) return;
  state.session.paused=true; state.session.pausedAt=nowMs();
  save(); setWake(false); renderAll();
}
function completeSession(){
  const prog=state.session.programPlanned;
  const entry={date:state.session.todayDate, program:prog, elapsedMs:sessionElapsedMs(), ss:(prog==="SS"?state.session.ss:null), ic:(prog==="IC"?state.session.ic:null)};
  state.history.push(entry);
  if(prog==="SS") state.counters.ssCounter=(state.counters.ssCounter||0)+1;

  state.session.startedAt=null; state.session.paused=false; state.session.pausedAt=null; state.session.totalPausedMs=0;
  state.session.checks={}; state.session.icSets=0; state.session.icDoneBeep=false;
  if(state.settings.enableSS && state.settings.enableIC) state.session.programPlanned = (prog==="SS")?"IC":"SS";
  state.session.ss=null; state.session.ic=null; state.session.icCountdownMs=null;
  save(); setWake(false); renderAll();
}

function coolElapsedMs(){
  if(!state.session.coolStartedAt) return 0;
  const base=(state.session.coolPaused?state.session.coolPausedAt:nowMs())-state.session.coolStartedAt;
  return Math.max(0, base-(state.session.coolTotalPausedMs||0));
}
function renderCool(){
  $("#coolStatus").textContent = state.session.coolStartedAt ? (state.session.coolPaused?"pauze":"loopt") : "klaar";
  $("#coolTime").textContent = state.session.coolStartedAt ? fmtMs(coolElapsedMs()) : "00:00";
}
function coolStart(){
  if(!state.session.coolStartedAt){
    state.session.coolStartedAt=nowMs(); state.session.coolPaused=false; state.session.coolTotalPausedMs=0; save(); renderAll(); return;
  }
  if(state.session.coolPaused){
    const pausedDur=nowMs()-(state.session.coolPausedAt||nowMs());
    state.session.coolTotalPausedMs=(state.session.coolTotalPausedMs||0)+pausedDur;
    state.session.coolPaused=false; state.session.coolPausedAt=null; save(); renderAll();
  }
}
function coolPause(){
  if(!state.session.coolStartedAt || state.session.coolPaused) return;
  state.session.coolPaused=true; state.session.coolPausedAt=nowMs(); save(); renderAll();
}
function coolReset(){
  state.session.coolStartedAt=null; state.session.coolPaused=false; state.session.coolPausedAt=null; state.session.coolTotalPausedMs=0; save(); renderAll();
}

function renderHistory(){
  const list=$("#histList"); list.innerHTML="";
  const h=state.history.slice().reverse();
  if(!h.length){ list.innerHTML='<div class="small">Nog geen sessies.</div>'; return; }
  h.slice(0,40).forEach(e=>{
    const mins=Math.round((e.elapsedMs||0)/60000);
    const title=`${e.date} · ${e.program==="SS"?"S&S":"IC"} · ${mins} min`;
    const sub=e.program==="SS" && e.ss ? `Micro #${e.ss.microIndex} · S ${e.ss.S}kg` : (e.program==="IC" && e.ic ? `${e.ic.sessionType} · ${e.ic.timeMin} min · ${e.ic.variantText}` : "");
    list.insertAdjacentHTML("beforeend", `<div class="item"><div class="left" style="flex-direction:column;align-items:flex-start;gap:4px"><div style="font-weight:850">${title}</div><div class="small">${sub}</div></div></div>`);
  });
}

function syncSettingsUI(){
  $("#setEnableSS").value=state.settings.enableSS?"1":"0";
  $("#setEnableIC").value=state.settings.enableIC?"1":"0";
  $("#ssBell").value=state.settings.ssBell;
  $("#ssBellPlus").value=state.settings.ssBellPlus;
  $("#twoArmEveryThird").value=state.settings.twoArmEveryThird?"1":"0";
  $("#timedVisible").value=state.settings.timedVisible?"1":"0";
  $("#icEasy").value=state.settings.icEasy;
  $("#icMed").value=state.settings.icMed;
  $("#icHeavy").value=state.settings.icHeavy;
  $("#icDoubleOK").value=state.settings.icDoubleOK?"1":"0";
}
function applySettings(){
  state.settings.enableSS=$("#setEnableSS").value==="1";
  state.settings.enableIC=$("#setEnableIC").value==="1";
  state.settings.ssBell=clamp4(safeInt($("#ssBell").value,24));
  state.settings.ssBellPlus=clamp4(safeInt($("#ssBellPlus").value, state.settings.ssBell+8));
  state.settings.twoArmEveryThird=$("#twoArmEveryThird").value==="1";
  state.settings.timedVisible=$("#timedVisible").value==="1";
  state.settings.icEasy=clamp4(safeInt($("#icEasy").value,16));
  state.settings.icMed=clamp4(safeInt($("#icMed").value,20));
  state.settings.icHeavy=clamp4(safeInt($("#icHeavy").value,24));
  state.settings.icDoubleOK=$("#icDoubleOK").value==="1";
  if(!state.settings.enableSS && !state.settings.enableIC) state.settings.enableSS=true;

  state.session.programPlanned=null;
  state.session.ss=null; state.session.ic=null;
  state.session.startedAt=null; state.session.paused=false; state.session.totalPausedMs=0;
  state.session.checks={}; state.session.icSets=0;
  save(); renderAll();
}
function resetAll(){
  if(!confirm("Alles resetten?")) return;
  localStorage.removeItem(LS_KEY);
  state=defaultState(); save(); renderAll();
}

function renderAll(){
  planForToday();
  const prog=state.session.programPlanned;
  $("#chipToday").textContent=`Vandaag: ${prog==="SS"?"S&S":"IC"}`;
  $("#chipIC").textContent = (prog==="IC" && state.session.ic) ? `IC: ${state.session.ic.sessionType} · ${state.session.ic.timeMin}m · ${state.session.ic.loadLevel}` : "IC: —";

  const tags=[];
  if(prog==="SS" && state.session.ss){
    const ss=state.session.ss;
    tags.push(`<span class="tag"><strong>S&amp;S</strong></span>`);
    tags.push(`<span class="tag"><strong>Micro</strong> #${ss.microIndex}</span>`);
    tags.push(`<span class="tag"><strong>Step</strong> +${ss.sPlusSets}/10</span>`);
    if(ss.timed && (ss.S>=32 || state.settings.timedVisible)) tags.push(`<span class="tag"><strong>Timed (S− ${ss.Sminus}kg)</strong></span>`);
    else tags.push(`<span class="tag"><strong>Practice</strong></span>`);
  }else if(prog==="IC" && state.session.ic){
    const ic=state.session.ic;
    tags.push(`<span class="tag"><strong>IC</strong></span>`);
    tags.push(`<span class="tag"><strong>${ic.sessionType}</strong></span>`);
    tags.push(`<span class="tag"><strong>${ic.timeMin} min</strong></span>`);
    tags.push(`<span class="tag"><strong>${ic.loadLevel}</strong> · ${ic.loadKg}kg</span>`);
  }
  $("#todayTags").textContent = tags.map(t=>t.replace(/<[^>]+>/g,"").replace(/\\s+/g," ").trim()).join(" · ");

  ["accWarm","accMain1","accMain2","accIC","accCool"].forEach(id=>{ const el=document.getElementById(id); if(el) setDetailsLabel(el); });

  if(prog==="SS"){
    $("#accIC").style.display="none";
    $("#accMain1").style.display="";
    $("#accMain2").style.display="";
    $("#timerModeTag").textContent="Stopwatch";
    $("#timerHint").textContent="S&S: stopwatch, loopt door bij app-switch.";
    renderSSLists();
  }else{
    $("#accIC").style.display="";
    $("#accMain1").style.display="none";
    $("#accMain2").style.display="none";
    $("#timerModeTag").textContent="Countdown";
    $("#timerHint").textContent="IC: countdown, dubbele beep op 0.";
    renderICBlock();
    $("#icSets").textContent=String(state.session.icSets||0);
  }

  renderTimer();
  renderCool();
  renderChips();
  renderHistory();
}

// tabs
function showTab(name){
  $("#tab-today").style.display=(name==="today")?"":"none";
  $("#tab-settings").style.display=(name==="settings")?"":"none";
  $("#tab-history").style.display=(name==="history")?"":"none";
  $$(".tab").forEach(b=>b.classList.toggle("active", b.dataset.tab===name));
  if(name==="settings") syncSettingsUI();
  if(name==="history") renderHistory();
}

$$(".tab").forEach(b=>b.addEventListener("click", ()=>showTab(b.dataset.tab)));
$("#btnStart").addEventListener("click", startSession);
$("#btnPause").addEventListener("click", pauseSession);
$("#btnComplete").addEventListener("click", completeSession);
$("#btnCoolStart").addEventListener("click", coolStart);
$("#btnCoolPause").addEventListener("click", coolPause);
$("#btnCoolReset").addEventListener("click", coolReset);
$("#btnIcPlus").addEventListener("click", ()=>{ state.session.icSets=(state.session.icSets||0)+1; save(); renderAll(); });
$("#btnIcMinus").addEventListener("click", ()=>{ state.session.icSets=Math.max(0,(state.session.icSets||0)-1); save(); renderAll(); });

["setEnableSS","setEnableIC","ssBell","ssBellPlus","twoArmEveryThird","timedVisible","icEasy","icMed","icHeavy","icDoubleOK"].forEach(id=>document.getElementById(id).addEventListener("change", applySettings));
$("#btnResetAll").addEventListener("click", resetAll);

setInterval(()=>{ renderTimer(); renderCool(); }, 250);

showTab("today");
renderAll();
</script>
</body>
</html>
